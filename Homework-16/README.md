## OTUS Linux Professional - Урок 24. Пользователи и группы. Авторизация и аутентификация.

#### Цель домашнего задания
Научиться создавать пользователей и добавлять им ограничения

#### Описание домашнего задания
1. Запретить всем пользователям кроме группы admin логин в выходные (суббота и воскресенье), без учета праздников

2*. Дать конкретному пользователю права работать с докером и возможность перезапускать докер сервис

#### Инструкция по выполнению

1. Запускаем виртуальную машину:
```console
$ vagrant up
```
2.  Подключаемся к нашей созданной ВМ:
```console
$ vagrant ssh
```
3. Переходим в root-пользователя:
```console
vagrant@pam:~$ sudo -i
```
4. Создаём пользователя otusadm и otus:
```console
root@pam:~# sudo useradd otusadm && sudo useradd otus
```
5. Создаём пользователям пароли:
```console
root@pam:~# passwd otusadm
root@pam:~# passwd otus
```
6. Создаём группу admin:
```console
root@pam:~# groupadd -f admin
```
7. Добавляем пользователей vagrant,root и otusadm в группу admin:
```console
root@pam:~# usermod otusadm -a -G admin && usermod root -a -G admin && usermod vagrant -a -G admin
```
> [!NOTE]
> Если не указать -a, то дополнительные группы, в которых состоит пользователь, и которые не указаны после опции -G буду удалены
> Не путать с параметром -g, который меняет основную группу для пользователя, в том числе права на каталог home пользователя. Параметр -G добавляет/удаляет
> только дополнительные группы, основную не трогает
8. После создания пользователей, нужно проверить, что они могут подключаться по SSH к нашей ВМ. Для этого пытаемся подключиться с хостовой машины:
```console
$ ssh otus@192.168.57.10
```
> [!NOTE]
> Если не удаётся войти и возращает сообщение "otus@192.168.57.10: Permission denied (publickey)." нужно проверить настройки sshd. В боксе "ubuntu/jammy64"
> файле /etc/ssh/sshd_config.d/60-cloudimg-settings.conf указано "PasswordAuthentication no", нужно изменить на yes

9. Далее настроим правило, по которому все пользователи кроме тех, что указаны в группе admin не смогут подключаться в выходные дни.

Выберем метод PAM-аутентификации. Так как у нас используется только ограничение по времени, то было бы логично использовать метод pam_time, однако, данный метод не работает с локальными группами пользователей, и, получается, что использование данного метода добавит нам большое количество однообразных строк с разными пользователями. В текущей ситуации лучше написать небольшой скрипт контроля и использовать модуль pam_exec.

Создадим файл-скрипт /usr/local/bin/login.sh

```shell
#!/bin/bash
#Первое условие: если день недели суббота или воскресенье
if [ $(date +%a) = "Sat" ] || [ $(date +%a) = "Sun" ]; then
 #Второе условие: входит ли пользователь в группу admin
 if getent group admin | grep -qw "$PAM_USER"; then
        #Если пользователь входит в группу admin, то он может подключиться
        exit 0
      else
        #Иначе ошибка (не сможет подключиться)
        exit 1
    fi
  #Если день не выходной, то подключиться может любой пользователь
  else
    exit 0
fi
```
10.  Добавим права на исполнение файла:
```console
root@pam:~# chmod +x /usr/local/bin/login.sh
```
11. Укажем в файле /etc/pam.d/sshd модуль pam_exec и наш скрипт:
```shell
# PAM configuration for the Secure Shell service

# Standard Un*x authentication.
@include common-auth

# only members of group "admin" can log in on weekends
auth required pam_exec.so debug /usr/local/bin/login.sh
...
...
```
12. Проверяем. Для этого устанавливаем дату на выходной день:
```console
# отключаем NTP
root@pam:~# timedatectl set-ntp no
# устанавливаем дату на прошлое Воскресенье
root@pam:~# date --set "last Sunday"
# проверяем
root@pam:~# date
Sun Jun 23 00:00:04 UTC 2024
```
Пытаемся подключится к виртуальной машине по ssh. Видим что под пользователем otus не удается войти, так как он не состоит в группе admin и не имеет права подключатся в выходные. Пользователь otusadm при этом логинится успешно.