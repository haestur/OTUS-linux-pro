## OTUS Linux Professional - Урок 15. Управление процессами.
---

#### ЦЕЛЬ: Работать с процессами

#### ЗАДАНИЕ: Написать свою реализацию ps ax используя анализ /proc

Вывод `ps ax` выглядит следующим образом:

То есть нам нужно с псевдофайловой системы /proc вытащить __PID__, __TTY__, __статус процесса__, __процессорное время__ и __команду запуска процесса__.

1. `PID`: Номер PID процесса в _/proc_ это числовые имена каталогов

2. `TTY`: Утилита `ps` вытаскивает имя терминала с файла _/proc/PID/stat_, значение __tty_nr__ (7е значение). Здесь указано десятичное число (тип __dev_t__), которое `ps` преобразовывает в имя устройства терминала. Делает он это с помощью макроса `linux/kdev_t.h`. Если быть точнее, то макрос преобразовывает __dev_t__ в номер __major,minor__ устройства.
Это преобразование можно сделать вручную. В документации сказано:
```
   tty_nr %d   (7) The controlling terminal of the process.  (The minor device number is contained in the combination of bits 31 to 20 and 7 to 0; the major device number is in bits 15 to 8.)
```
Возьмем, например, значение __dev_t__ - __34823__. Чтобы узнать номер устройства нужно перевести это число в двоичный 32х битный вид и воспользоваться документацией выше:

Комбинация из зеленых цветов это __minor__ номер устройства = 7

Комбинация из желтых цветов это __major__ номер устройства = 136

То есть номер устройства __(136,7)__. Дальше с помощью `ls -l /dev/pts/ /dev/tty*` мы можем посмотреть какое имя терминала соответствует этому номеру устройства (в нашем случае это /dev/pts/7)

3. `STAT`: Вытаскиваем с _/proc/PID/stat_ или _/proc/PID/status_. Возможные состояния процесса см. в `man ps`

4. `TIME`: Как долго процессор был занят процессом. Берём из _/proc/PID/stat_. В этом файле за процессорное время отвечают два значения:
   __utime__ - процессорное время, занятое процессом в user mode
   __stime__ -  процессорное время, занятое процессом в kernel mode
   Эти два значения нужно суммировать. Также следует учесть, что здесь время указано в __clock ticks__. Нужно перевести в секунды. Чтобы узнать сколько clock ticks в одной секунде смотрим параметры системы:
   ```
   $ getconf CLK_TCK
   100
   ```
   То есть, общее процессорное время, зянятое процессом:
   ```
   TIME = (utime + stime)/100
   ```
6. `COMMAND`: Берём из _/proc/PID/cmdline_. Если _/proc/PID/cmdline_ пустой - используем _/proc/PID/stat_, второе значение. Если процесс запущен без аргументов, то помещаем его в квадратные скобки (так делает `ps`)
